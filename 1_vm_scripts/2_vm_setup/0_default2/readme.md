# Dynamic Deployment
The dynamic deployment part consists of two parts. It realises the functions to setup the instances and configure required softwares and scale up **with one click**.

1. The setup and control of the vm machines on Nectar is via the boto library.
   1. creating the instances via **configure.json** or **command line** argument is implenmented by the **deploy.py**
   2. the control of the instances via **command line argument** isimplemented by the **controller.py**

2. The automatic configuration of softwares using ansible library.
   1. The **inventory** of the target hosts will be automatically generated by the **deploy.py**. Then the **yamls templates** in the ./template: **couchdb.yml, searcher.yml, streamer.yml, webserver.yml** will be runned by the deploy.py script according to the hosts in the inventory file.

There are two video demos in the beginning of our project youtube video.  Link 1

One is showing deploy two instances with one click — 1 with combo (couchDB + crawler + sentimental packages) installed and running, 1 with web server running.

Another is showing scaling a couchDB to an existing couchDB with a click. But the adding nodes have to be manually done. Also there is no volume attached to these instances due to the temporary instances are used for testing.

BTW: In case of testing, there are also two video demos separately showing the successful dynamic deployment of dynamic deployment of the couchDB cluster in one click (link 2) and setup of a couchDB with volume (Link3).

## 1. Prerequisites

1. The control machine:

   ```shell
   python3
   ```

2. python packages:

   ```
   boto
   ansible 2.5
   ```

3. nectar

   1. all server image is default to be "NeCTAR Ubuntu 16.04 LTS (Xenial) amd64".
   2. Following security group needs to be pre-create: ssh, default, node(web:with TCP port 3000 open for all CIDR)
   3. the key pair: group25.pem for nectar need to be set
   4. the ec2 access ky and ec2 secret key need to be provided.

   ​

## 2. Introduction

<u>The deploy.py will **automatically setup or scale up the instances **and **run the ansible-playbooks to configure the corresponding softwares**. It is more clearer for us to divide them into two parts and have discussion in this report.</u>

```shell
 # 1. deploy.py
 python3 deploy.py <configure.json> <sys_type> <number_of_instances>
 
 # e.g
 # This will creates two instances, with couchdb running on each instance.
 python3 deploy.py configure.json couchdb 2
 
 # 2. controller.py
 # The controller supports different operations on instance, volume   and snapshot.
 python3 controller.py <action> <value_type> <value> <target>
 
 # e.g
 # This terminates the instance with id i-d7da2302, "default" is a placeholder.
 python3 controller.py terminate instance i-d7da2302 default
 # This will attach a volume with 40G to the instance with id:i-d7da2302
 python3 controller.py attach volume 40 i-d7da2302
```

### 3. boto part:

### 3.1 create instances

There are three ways to create instances: 1. deploy.py (via configure.json)  2. deploy.py (via command line argument)  3. controller.py

1. The creation of the instance depends on the configuration file: **configure.json **, which specifies the nectar credentials and the instances details. It requires the dependent security groups and key pair (group25.pem) is already setup. (**deploy.py**)
2. The scale up of the instances is suggested to use the command line argument in **deploy.py**. But it requires the configure.json specifies the correspoding server type.
3. Also **controller.py** also could be used to setup the script (python3 controller.py create instance  \<instance-name\> default)


#### 3.1.1 deploy.py

We support six types of server:

1. couchdb (The server with couchdb running)
2. streamer (The server with streaming harvester running)
3. searcher (The server with searching harvester running)
4. **combo** (couchdb + streamer + searcher running)
5. webserver (webserver running)
6. default (which creates the instances as specified in the configure.json and with correspongding softwares running)

**By the way, we provide the configure.json (two nodes) and configure_project.json (4 nodes) as examples.**

If there are more than 2 combo/couchdb in the configure.json file and "default" mode is used. **It will automatically formalise the cluster as we shown in the <u>video</u>**.

```shell
# for example, 3 combo + 1 webserver
python3 deploy.py default 4

# create a couchdb same as the one specified in the configure.json
python3 deploy.py couchdb 1
```

#### Automatically configure the required softwares

1. After that it will automatically generate the inventory file for the ansible-playbooks.
2. Then it will run the ansible-playbook by calling the predefined yaml file: (cluster.yml, combo.yml, couchdb.yml, searcher.yml, streamer.yml, webserver.yml)
3. It will automatically formalise the couchdb cluster if running in the default mode with at least two couchdb instances

#### Future

TODO LIST:

1. The auth_index for different crawlers should be dynamic. 

   Solution: We could use the database like mysql to maintain the configuration tables for more flexiable deployment.

2. It is not safe to use github key directly.

   Solution: We could use the database like mysql to maintain the configuration tables for the security reason.

#### 3.1.2 controller.py

You could also create the instance from deploy.py.

```
python3 controller.py create instance <instance-name>
```

### 3.2 control the instance (controller.py)

```shell
python3 controller.py <action> <value_type> <value> <target>
# Where: <action>         -- create / terminate / delete / attach / recover
#        <value_type>      -- instance / volume / snapshot
#        <value>           -- streamer (depends on value_type and action)
#        <target>    -- default / streamer (instance-name)
```

Here are some examples for using this script.

### 3.2.1 instance related operations

#### 1. GET action

```shell
# 1. get the instances info
python controller.py get instance info default
```

![3_instances_info](/Users/youshaoxiao/PycharmProjects/cluster_and_cloud_2018/1_vm_scripts/2_vm_setup/0_default2/readme_images/3_instances_info.jpg)

#### 2. terminate action

```shell
# 2. terminate the instance
# if the volume is attached to the instance, it will only detach the volume.
python controller.py terminate <instance-id> default
```

##![4_terminate_instance](/Users/youshaoxiao/PycharmProjects/cluster_and_cloud_2018/1_vm_scripts/2_vm_setup/0_default2/readme_images/4_terminate_instance.jpg) 

#### 3. create action

```shell
# This creates a medium size instance with ubuntu 16.04
# python controller.py create <instance-name> default
python controller.py create couchdb-slave default
```

### 3.2.2 volume related operations 

```shell
# 1. get the volume info
python controller.py get volume info default
# 2. delete the volume: it will firstly detach the volume if it is attached.
python controller.py delete volume vol-c7f34877 default
# 3. create volume with the size to existing instance
python controller.py create volume 40 i-d7da2302
```

![5_delete_volume](/Users/youshaoxiao/PycharmProjects/cluster_and_cloud_2018/1_vm_scripts/2_vm_setup/0_default2/readme_images/5_delete_volume.jpg)

### 3.2.3 snapshot related operations

```shell
# 1. create the snapshot of the volume
python controller.py create snapshot vol-f5a3a3f2 default
# 2. delete the snapshot of the volume
python controller.py delete snapshot snap-ebffc956 default
# 3. recover the snapshot in a new volume and attach to the existing instance
# python controller.py recover snapshot <snap-id> <instance-id>
python controller.py recover snapshot snap-f5a3a3f2 i-d7da2302
```

![6_create_the_snapshot](/Users/youshaoxiao/PycharmProjects/cluster_and_cloud_2018/1_vm_scripts/2_vm_setup/0_default2/readme_images/6_create_the_snapshot.jpg)



## 4. ansible

There deploy.py will automatically generate the inventory file and call the corresponding playbooks (yaml).

The ansible part consists of the inventory and playbook.yaml which locates in cluster_and_cloud_2018/1_vm_scripts/2_vm_setup/0_default2/template:

1. combo.yml: playbook to run the couchdb + streamer + searcher
   * there are two versions: combo_with_volume and combo_without_volume (whether mount the volume on the directory). If you wanna to test either, just copy the required templates to cluster_and_cloud_2018/1_vm_scripts/2_vm_setup/0_default2/template.
2. couchdb.yml: playbook to run the couchdb
   * there are two versions: couchdb_with_volume and couchdb_without_volume (whether mount the volume on the directory). If you wanna to test either, just copy the required templates to cluster_and_cloud_2018/1_vm_scripts/2_vm_setup/0_default2/template.
3. searcher.yml: playbook to run the searcher 
4. streamer.yml: playbook to run the streamer
5. webserver.yml: playbook to run the webserver
6. cluster.yml: playbook to formalise the couchdb cluster in default mode.

## 5. TODO list

1. Rather than using configure file, database is preferred to maintain the configuration details since databse tables are more easy to maintain and good structure and synchronisation feature.
2. securtiy: password for git clone and couchdb and nectar key pair and nectar access key
3. monitor system should be implemented to monitor the status of service
