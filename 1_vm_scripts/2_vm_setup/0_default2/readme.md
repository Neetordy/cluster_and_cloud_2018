# Dynamic Deployment part

The dynamic deployment part consists of two parts. It realises the functions to setup the instances and configure required softwares and scale up with one click.

1. The setup and control of the vm machines on Nectar via the boto library.
   1. creating the instances via **configure.json** or **command line** argument is implenmented by the **deploy.py**
   2. the control of the instances via **command line argument** is implemented by the **controller.py**


2. The automatic configuration of softwares using ansible library.
   1. The **inventory** of the target hosts will be automatically generated by the **deploy.py**. Then the **yamls templates** in the ./template: **couchdb.yml, searcher.yml, streamer.yml, webserver.yml** will be runned by the deploy.py script according to the hosts in the inventory file.

## 1. Prerequisites

1. The control machine:

   ```shell
   python3
   ansible 2.5.1
   ```

2. python packages:

   ```
   boto
   ```

## 2. Introduction

<u>The deploy.py will **automatically setup or scale up all the instances **and **run the ansible-playbooks to configure the corresponding softwares**. But it is more clearer for us to divide them into two parts in this report.</u>

```shell
 # 1. deploy.py
 python3 deploy.py <configure.json> <sys_type> <number_of_instances>
 
 # e.g
 # This will creates two instances, with couchdb running on each instance.
 python3 deploy.py configure.json couchdb 2
 
 # 2. controller.py
 # The controller supports different operations on instance, volume   and snapshot.
 python3 controller.py <action> <value_type> <value> <target>
 
 # e.g
 # This terminates the instance with id i-d7da2302, "default" is a placeholder.
 python3 controller.py terminate instance i-d7da2302 default
 # This will attach a volume with 40G to the instance with id:i-d7da2302
 python3 controller.py attach volume 40 i-d7da2302
```

###3. boto part:

### 3.1 create instance

1. The creation of the instance depends on the configuration file: **configure.json **, which specifies the nectar credentials and the instances details. It requires the dependent security groups and key pair (group25.pem) is already setup.
2. The scale up of the instances is suggested to use the command line argument in deploy.py



We support five kinds of system:

1. couchdb
2. streamer
3. ​

### 3.2 control the instance

### 1. GET action for instance and volume

```shell
# 1. get the instances info
python controller.py get instance info default
```

![3_instances_info](/Users/youshaoxiao/PycharmProjects/cluster_and_cloud_2018/1_vm_scripts/2_vm_setup/0_default2/readme_images/3_instances_info.jpg)

```shell
# 2. get the volumes info
python controller.py get volume info default
```

![2_volume_info](/Users/youshaoxiao/PycharmProjects/cluster_and_cloud_2018/1_vm_scripts/2_vm_setup/0_default2/readme_images/2_volume_info.jpg)



## 

## 4. ansible



## 5. Usage example



## 6. TEST





## 7. TODO list

1. Rather than using configure file, i would prefer to use database to maintain the configuration details.
2. securtiy: password for git clone and couchdb and nectar key pair and nectar access key
3. 负载均衡



# 8. nectar

1. The termination of some instances have to wait for a long time.
2. The termination of some volumes have to wait for a long time.
3. The response of web page is very slow.
4. ​